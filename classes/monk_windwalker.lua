local _,Analyzer=...if not Analyzer then return end
local module={}
local utils=Analyzer.utils
module.name="Monk - Windwalker"
module.class="MONK"
module.specKey="windwalker"
module.specIndex=3
module.specId=269
local SPELL_TIGER_PALM=100780
local SPELL_BLACKOUT_KICK=100784
local SPELL_RISING_SUN_KICK=107428
local SPELL_FISTS_OF_FURY=113656
local SPELL_SPINNING_CRANE_KICK=101546
local SPELL_TOUCH_OF_DEATH=115080
local SPELL_ENERGIZING_BREW=115288
local SPELL_TIGEREYE_BREW=116740
local SPELL_TIGEREYE_BREW_BUFF=125195
local SPELL_COMBO_BREAKER_BOK=116768
local SPELL_COMBO_BREAKER_TP=118864
local SPELL_RISING_SUN_KICK_DEBUFF=130320
local SPELL_INVOKE_XUEN=123904
local COOLDOWN_RISING_SUN_KICK=8
local COOLDOWN_FISTS_OF_FURY=25
local COOLDOWN_XUEN=180
local SOUND_KEY_COMBO_BREAKER="comboBreaker"
local SOUND_KEY_TIGEREYE_BREW="tigereyeBrew"
local SOUND_KEY_TOUCH_OF_DEATH="touchOfDeath"
local TRACKED_BUFFS={[SPELL_TIGEREYE_BREW_BUFF]=true,[SPELL_COMBO_BREAKER_BOK]=true,[SPELL_COMBO_BREAKER_TP]=true,[SPELL_ENERGIZING_BREW]=true}
local TRACKED_DEBUFFS={[SPELL_RISING_SUN_KICK_DEBUFF]=true}
local TRACKED_CASTS={[SPELL_TIGER_PALM]=true,[SPELL_BLACKOUT_KICK]=true,[SPELL_RISING_SUN_KICK]=true,[SPELL_FISTS_OF_FURY]=true,[SPELL_SPINNING_CRANE_KICK]=true,[SPELL_TOUCH_OF_DEATH]=true,[SPELL_ENERGIZING_BREW]=true,[SPELL_TIGEREYE_BREW]=true,[SPELL_INVOKE_XUEN]=true}
local function EH(c,s)c[s]=c[s]or{}return c[s]end
function module.SupportsSpec(a)if a.player.class~=module.class then return false end if a.player.specId==module.specId then return true end local sk=utils.NormalizeSpecKey(a.player.specName)if sk==module.specKey then return true end if a.player.specIndex==module.specIndex then return true end return false end
function module.OnPlayerInit(a)if a.player.class~=module.class then return end if a.player.specName~="Unknown"then return end if IsSpellKnown and IsSpellKnown(SPELL_FISTS_OF_FURY)and IsSpellKnown(SPELL_RISING_SUN_KICK)then a.player.specName="Windwalker"a.player.specId=a.player.specId or module.specId a.player.specIndex=a.player.specIndex or module.specIndex end end
function module.GetDefaultSettings()return{sounds={[SOUND_KEY_COMBO_BREAKER]={enabled=true,sound="Sound\\Interface\\RaidWarning.ogg"},[SOUND_KEY_TIGEREYE_BREW]={enabled=true,sound="Sound\\Interface\\MapPing.ogg"},[SOUND_KEY_TOUCH_OF_DEATH]={enabled=true,sound="Sound\\Interface\\RaidWarning.ogg"}}}end
function module.GetSoundOptions()return{{key=SOUND_KEY_COMBO_BREAKER,label="Combo Breaker Proc"},{key=SOUND_KEY_TIGEREYE_BREW,label="Tigereye Brew 10 Stacks"},{key=SOUND_KEY_TOUCH_OF_DEATH,label="Touch of Death Available"}}end
function module.IsTrackedBuffSpell(s)return TRACKED_BUFFS[s]==true end
function module.IsTrackedDebuffSpell(s)return TRACKED_DEBUFFS[s]==true end
function module.IsTrackedCast(s)return TRACKED_CASTS[s]==true end
function module.ShouldRecordCast(e)if not e or not e.spellId then return false end return TRACKED_CASTS[e.spellId]==true end
function module.GetProcInfo(s)if s==SPELL_COMBO_BREAKER_BOK or s==SPELL_COMBO_BREAKER_TP then return{soundKey=SOUND_KEY_COMBO_BREAKER,priority=3}elseif s==SPELL_TIGEREYE_BREW_BUFF then return{soundKey=SOUND_KEY_TIGEREYE_BREW,priority=2}end return nil end
function module.InitFight(_,f)f.procs={comboBreakerProcs=0,comboBreakerConsumed=0}f.counts={risingSunKickCasts=0,fistsOfFuryCasts=0,touchOfDeathCasts=0}f.cooldowns={xuenLast=0}f.castLog={}f.buffHistory={}f.debuffHistory={}f.rotation={totalCasts=0,optimalCasts=0,suboptimalCasts=0,mistakes={},penaltySum=0}f.tigereyeStacks=0 end
function module.TrackSpellCast(a,s,t)local f=a.fight if not f or not TRACKED_CASTS[s]then return end local n=utils.NormalizeTimestamp(t)f.spells[s]=(f.spells[s]or 0)+1 table.insert(f.castLog,{spellId=s,timestamp=n})if s==SPELL_RISING_SUN_KICK then f.counts.risingSunKickCasts=f.counts.risingSunKickCasts+1 elseif s==SPELL_FISTS_OF_FURY then f.counts.fistsOfFuryCasts=f.counts.fistsOfFuryCasts+1 a:AddTimelineEvent(s,n,"cooldown")elseif s==SPELL_TOUCH_OF_DEATH then f.counts.touchOfDeathCasts=f.counts.touchOfDeathCasts+1 a:AddEventLog(n,"Touch of Death",s)elseif s==SPELL_BLACKOUT_KICK then local b=f.buffs[SPELL_COMBO_BREAKER_BOK]if b then f.procs.comboBreakerConsumed=f.procs.comboBreakerConsumed+1 f.buffs[SPELL_COMBO_BREAKER_BOK]=nil end elseif s==SPELL_TIGER_PALM then local b=f.buffs[SPELL_COMBO_BREAKER_TP]if b then f.procs.comboBreakerConsumed=f.procs.comboBreakerConsumed+1 f.buffs[SPELL_COMBO_BREAKER_TP]=nil end elseif s==SPELL_TIGEREYE_BREW then a:AddTimelineEvent(s,n,"cooldown")a:AddEventLog(n,"Tigereye Brew",s)elseif s==SPELL_INVOKE_XUEN then f.cooldowns.xuenLast=n a:AddTimelineEvent(s,n,"cooldown")a:AddEventLog(n,"Invoke Xuen",s)end local cS={[SPELL_TIGER_PALM]=true,[SPELL_BLACKOUT_KICK]=true,[SPELL_RISING_SUN_KICK]=true,[SPELL_FISTS_OF_FURY]=true}if cS[s]and f.rotation then local ev=module.EvaluateCast(a,f,s,n)if ev then module.RecordCastEvaluation(f,ev,n)end end end
function module.TrackAura(a,se,s,am,t)local f=a.fight if not f then return end local n=utils.NormalizeTimestamp(t)if se=="SPELL_AURA_APPLIED"or se=="SPELL_AURA_APPLIED_DOSE"or se=="SPELL_AURA_REFRESH"then local st=am or 1 local b=f.buffs[s]local isR=(se=="SPELL_AURA_REFRESH")if b and isR and b.since then f.buffUptime[s]=(f.buffUptime[s]or 0)+(n-b.since)end if not b then b={stacks=st,since=n}f.buffs[s]=b else b.stacks=st b.since=b.since or n end if isR then b.since=n end local h=EH(f.buffHistory,s)if isR and b.historyEntry and not b.historyEntry.removed then b.historyEntry.removed=n end if not b.historyEntry or isR then b.historyEntry={applied=n}table.insert(h,b.historyEntry)end if s==SPELL_COMBO_BREAKER_BOK or s==SPELL_COMBO_BREAKER_TP then if not isR then f.procs.comboBreakerProcs=f.procs.comboBreakerProcs+1 end a:PlayAlertSound(SOUND_KEY_COMBO_BREAKER,n)elseif s==SPELL_TIGEREYE_BREW_BUFF then f.tigereyeStacks=st if st>=10 then a:PlayAlertSound(SOUND_KEY_TIGEREYE_BREW,n)end end elseif se=="SPELL_AURA_REMOVED"then local b=f.buffs[s]if b then if b.since then f.buffUptime[s]=(f.buffUptime[s]or 0)+(n-b.since)end if b.historyEntry and not b.historyEntry.removed then b.historyEntry.removed=n end end f.buffs[s]=nil if s==SPELL_TIGEREYE_BREW_BUFF then f.tigereyeStacks=0 end end end
function module.TrackDebuff(a,se,s,dG,dN,t)local f=a.fight if not f or not TRACKED_DEBUFFS[s]then return end local n=utils.NormalizeTimestamp(t)if not f.primaryTargetGUID then f.primaryTargetGUID=dG end if dG and f.primaryTargetGUID and dG~=f.primaryTargetGUID then return end if dG then f.targets[dG]=true end local d=f.debuffs[s]local h=EH(f.debuffHistory,s)if se=="SPELL_AURA_APPLIED"then f.debuffs[s]={since=n,targetGUID=dG}local e={applied=n}table.insert(h,e)f.debuffs[s].historyEntry=e elseif se=="SPELL_AURA_REFRESH"then if d and d.since then f.debuffUptime[s]=(f.debuffUptime[s]or 0)+(n-d.since)end if d and d.historyEntry and not d.historyEntry.removed then d.historyEntry.removed=n end f.debuffs[s]={since=n,targetGUID=dG}local e={applied=n}table.insert(h,e)f.debuffs[s].historyEntry=e elseif se=="SPELL_AURA_REMOVED"then if d and d.since then f.debuffUptime[s]=(f.debuffUptime[s]or 0)+(n-d.since)end if d and d.historyEntry and not d.historyEntry.removed then d.historyEntry.removed=n end f.debuffs[s]=nil end end
function module.Analyze(a,f,c)local m={}local i={}local sc=100 if c.duration<15 then utils.AddIssue(i,"Walka zbyt krotka.")return{score=0,metrics=m,issues=i}end local function AM(l,s,v,p,st,it,pen)table.insert(m,{label=l,spellId=s,valueText=v or"",percent=p,status=st or"info"})utils.AddIssue(i,it)if pen and pen>0 then sc=utils.Clamp(sc-pen,0,100)end end local rskUp=utils.SafePercent(f.debuffUptime[SPELL_RISING_SUN_KICK_DEBUFF]or 0,c.duration)local rskSt=utils.StatusForPercent(rskUp,0.90,0.75)AM("Rising Sun Kick debuff uptime",SPELL_RISING_SUN_KICK,utils.FormatPercent(rskUp),rskUp,rskSt,rskSt=="bad"and"Niski uptime RSK debuff."or(rskSt=="warn"and"RSK debuff moglby byc wyzszy."or nil),rskSt=="bad"and 12 or(rskSt=="warn"and 6 or 0))local rsk=f.spells[SPELL_RISING_SUN_KICK]or 0 local expRSK=math.floor(c.duration/COOLDOWN_RISING_SUN_KICK)if expRSK>0 then local rskP=utils.SafePercent(rsk,expRSK)local rskUSt=utils.StatusForPercent(rskP,0.85,0.70)AM("Rising Sun Kick uzycia",SPELL_RISING_SUN_KICK,string.format("%d/%d",rsk,expRSK),math.min(rskP or 0,1),rskUSt,rskUSt=="bad"and"Za malo Rising Sun Kick."or(rskUSt=="warn"and"RSK uzywany zbyt rzadko."or nil),rskUSt=="bad"and 10 or(rskUSt=="warn"and 5 or 0))end local fof=f.spells[SPELL_FISTS_OF_FURY]or 0 local expFOF=utils.ExpectedUses(c.duration,COOLDOWN_FISTS_OF_FURY,10)if expFOF>0 then local fofP=utils.SafePercent(fof,expFOF)local fofSt=utils.StatusForPercent(fofP,0.80,0.60)AM("Fists of Fury uzycia",SPELL_FISTS_OF_FURY,string.format("%d/%d",fof,expFOF),math.min(fofP or 0,1),fofSt,fofSt=="bad"and"Za malo Fists of Fury."or(fofSt=="warn"and"FOF uzywany zbyt rzadko."or nil),fofSt=="bad"and 10 or(fofSt=="warn"and 5 or 0))end local cbP=f.procs.comboBreakerProcs or 0 local cbC=f.procs.comboBreakerConsumed or 0 if cbP>0 then local cbU=utils.SafePercent(cbC,cbP)local cbSt=utils.StatusForPercent(cbU,0.85,0.70)AM("Combo Breaker wykorzystanie",SPELL_COMBO_BREAKER_BOK,string.format("%s (%d/%d)",utils.FormatPercent(cbU),cbC,cbP),cbU,cbSt,cbSt=="bad"and"Za duzo CB nie zuzyte."or(cbSt=="warn"and"Czesc CB sie marnuje."or nil),cbSt=="bad"and 10 or(cbSt=="warn"and 5 or 0))end if f.rotation and f.rotation.totalCasts>0 then local rS=module.GetRotationScore(f)if rS then local rA=rS.accuracy or 0 local rSt=utils.StatusForPercent(rA,0.85,0.70)AM("Dokladnosc rotacji (APL)",nil,string.format("%.0f%% (%d/%d)",rA*100,rS.optimalCasts,rS.totalCasts),rA,rSt,rSt=="bad"and"Niska dokladnosc."or(rSt=="warn"and"Srednia dokladnosc."or nil),rSt=="bad"and 10 or(rSt=="warn"and 5 or 0))if rS.mistakes and #rS.mistakes>0 then local mC={}for _,mk in ipairs(rS.mistakes)do mC[mk.reason or"Unknown"]=(mC[mk.reason or"Unknown"]or 0)+1 end local sM={}for r,ct in pairs(mC)do table.insert(sM,{reason=r,count=ct})end table.sort(sM,function(x,y)return x.count>y.count end)for j=1,math.min(3,#sM)do local mk=sM[j]if mk.count>=2 then utils.AddIssue(i,string.format("Blad rotacji (%dx): %s",mk.count,mk.reason))end end end end end sc=utils.Clamp(sc,0,100)return{score=sc,metrics=m,issues=i}end
function module.GetLiveScore(a,f)if not f then return nil end local n=GetTime()local d=n-f.startTime if d<5 then return nil end return 100 end
local function CPB(s)if not s then return false,0 end for i=1,40 do local _,_,st,_,_,_,_,_,_,aS=UnitBuff("player",i)if not aS then break end if aS==s then return true,st or 1 end end return false,0 end
local function CTD(s)if not s or not UnitExists("target")then return false,0 end for i=1,40 do local _,_,_,_,_,eT,_,c,_,_,aS=UnitDebuff("target",i)if not aS then break end if aS==s and c=="player"then local r=eT and(eT-GetTime())or 0 return true,r end end return false,0 end
local function GChi()return UnitPower("player",12)or 0 end
local function GEnergy()return UnitPower("player",3)or 0 end
local function GTEB()local _,stacks=CPB(SPELL_TIGEREYE_BREW_BUFF)return stacks or 0 end
function module.GetLiveAdvice(a,f)if not f then return""end local n=GetTime()local d=n-f.startTime local chi=GChi()local teb=GTEB()local hasCBok,_=CPB(SPELL_COMBO_BREAKER_BOK)local hasCBtp,_=CPB(SPELL_COMBO_BREAKER_TP)if teb>=10 then return"Tigereye Brew! (10 stackow)"end if utils.IsSpellReady(SPELL_RISING_SUN_KICK)and chi>=2 then return"Rising Sun Kick!"end if hasCBok then return"Blackout Kick! (Combo Breaker)"end if hasCBtp then return"Tiger Palm! (Combo Breaker)"end if utils.IsSpellReady(SPELL_FISTS_OF_FURY)and chi>=3 then return"Fists of Fury!"end if chi>=2 then return"Blackout Kick!"end return""end
function module.GetAdviceSpellIcon(a,f)if not f then return nil end local n=GetTime()local d=n-f.startTime local chi=GChi()local teb=GTEB()local hasCBok,_=CPB(SPELL_COMBO_BREAKER_BOK)local hasCBtp,_=CPB(SPELL_COMBO_BREAKER_TP)if teb>=10 then return SPELL_TIGEREYE_BREW end if utils.IsSpellReady(SPELL_RISING_SUN_KICK)and chi>=2 then return SPELL_RISING_SUN_KICK end if hasCBok then return SPELL_BLACKOUT_KICK end if hasCBtp then return SPELL_TIGER_PALM end if utils.IsSpellReady(SPELL_FISTS_OF_FURY)and chi>=3 then return SPELL_FISTS_OF_FURY end if chi>=2 then return SPELL_BLACKOUT_KICK end return nil end
local APL_PRIORITY={{id="teb",spellId=SPELL_TIGEREYE_BREW,name="Tigereye Brew",condition=function(s)return s.tebStacks>=10 end,priority=1,category="cooldown"},{id="rsk",spellId=SPELL_RISING_SUN_KICK,name="Rising Sun Kick",condition=function(s)return s.rskReady and s.chi>=2 end,priority=2,category="core"},{id="bok_cb",spellId=SPELL_BLACKOUT_KICK,name="BOK(CB)",condition=function(s)return s.comboBreakerBOK end,priority=3,category="proc"},{id="tp_cb",spellId=SPELL_TIGER_PALM,name="TP(CB)",condition=function(s)return s.comboBreakerTP end,priority=4,category="proc"},{id="fof",spellId=SPELL_FISTS_OF_FURY,name="Fists of Fury",condition=function(s)return s.fofReady and s.chi>=3 end,priority=5,category="cooldown"},{id="bok",spellId=SPELL_BLACKOUT_KICK,name="Blackout Kick",condition=function(s)return s.chi>=2 end,priority=6,category="spender"},{id="tp",spellId=SPELL_TIGER_PALM,name="Tiger Palm",condition=function(s)return true end,priority=7,category="builder"}}
local function GCS(a,f)local s={duration=0,chi=0,energy=0,tebStacks=0,rskReady=false,fofReady=false,comboBreakerBOK=false,comboBreakerTP=false}if not f then return s end local n=GetTime()s.duration=n-(f.startTime or n)s.chi=GChi()s.energy=GEnergy()s.tebStacks=GTEB()s.rskReady=utils.IsSpellReady(SPELL_RISING_SUN_KICK)s.fofReady=utils.IsSpellReady(SPELL_FISTS_OF_FURY)s.comboBreakerBOK=CPB(SPELL_COMBO_BREAKER_BOK)s.comboBreakerTP=CPB(SPELL_COMBO_BREAKER_TP)return s end
function module.GetNextAPLAction(a,f)local s=GCS(a,f)for _,act in ipairs(APL_PRIORITY)do if act.condition(s)then return act end end return APL_PRIORITY[#APL_PRIORITY]end
function module.GetAPLPriorityList()return APL_PRIORITY end
function module.GetRotationState(a,f)return GCS(a,f)end
function module.EvaluateCast(a,f,sid,ts)local nA=module.GetNextAPLAction(a,f)if not nA then return nil end local isO=(nA.spellId==sid)local pen=0 local rsn=""if not isO then local cP=nil for _,act in ipairs(APL_PRIORITY)do if act.spellId==sid then cP=act.priority break end end if cP then pen=math.abs(nA.priority-cP)*2 rsn=string.format("Powinienes: %s",nA.name)else pen=5 rsn="Spell poza APL"end end return{isOptimal=isO,penalty=pen,reason=rsn,expectedSpell=nA.spellId,expectedName=nA.name,actualSpell=sid}end
function module.RecordCastEvaluation(f,ev,ts)if not f.rotation then return end f.rotation.totalCasts=f.rotation.totalCasts+1 if ev.isOptimal then f.rotation.optimalCasts=f.rotation.optimalCasts+1 else f.rotation.suboptimalCasts=f.rotation.suboptimalCasts+1 f.rotation.penaltySum=f.rotation.penaltySum+ev.penalty table.insert(f.rotation.mistakes,{timestamp=ts,reason=ev.reason,penalty=ev.penalty,expected=ev.expectedName})end end
function module.GetRotationScore(f)if not f.rotation or f.rotation.totalCasts==0 then return nil end return{accuracy=f.rotation.optimalCasts/f.rotation.totalCasts,totalCasts=f.rotation.totalCasts,optimalCasts=f.rotation.optimalCasts,suboptimalCasts=f.rotation.suboptimalCasts,mistakes=f.rotation.mistakes,penaltySum=f.rotation.penaltySum}end
Analyzer:RegisterClassModule(module.class,module)
